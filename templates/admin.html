<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者 - Python Playground</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Python Playground</h1>
            <p>管理者頁面 - 任務指派</p>
        </div>
        <nav>
            <a href="/python_playground/">練習區</a>
            <a href="/python_playground/overview">總覽</a>
            <a href="/python_playground/admin" class="active">管理者</a>
        </nav>
    </header>

    <main class="admin-container">
        <section class="admin-section">
            <h2>快速指派相同任務給所有組別</h2>
            <div class="quick-assign">
                <textarea id="quick-task" placeholder="輸入要指派給所有組別的任務..."></textarea>
                <button class="btn btn-primary" onclick="assignToAll()">指派給所有組別</button>
            </div>
        </section>

        <section class="admin-section">
            <h2>預設任務範本</h2>
            <div class="task-templates">
                <button class="btn btn-template" onclick="useTemplate(1)">基礎練習</button>
                <button class="btn btn-template" onclick="useTemplate(2)">演算法</button>
                <button class="btn btn-template" onclick="useTemplate(3)">圖形輸出</button>
                <button class="btn btn-template" onclick="useTemplate(4)">資料處理</button>
                <button class="btn btn-template" onclick="useTemplate(5)">模擬實驗</button>
                <button class="btn btn-template" onclick="useTemplate(6)">綜合挑戰</button>
            </div>
        </section>

        <section class="admin-section">
            <h2>個別組別任務指派</h2>
            <div class="individual-tasks">
                {% for group_id in range(1, 7) %}
                <div class="task-card">
                    <div class="task-header">
                        <h3>第 {{ group_id }} 組</h3>
                        <div class="task-header-actions">
                            <span class="history-badge" id="history-badge-{{ group_id }}">歷史: {{ groups_data[group_id].history|length }}</span>
                            <button class="btn btn-small btn-save" onclick="saveTask({{ group_id }})">更新任務</button>
                        </div>
                    </div>
                    <textarea id="admin-task-{{ group_id }}" class="task-input">{{ groups_data[group_id].task }}</textarea>
                    <div class="task-status">
                        <span>程式碼: {{ '已撰寫' if groups_data[group_id].code else '尚未撰寫' }}</span>
                        <span>執行: {{ groups_data[group_id].last_run if groups_data[group_id].last_run else '尚未執行' }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <section class="admin-section">
            <h2>批次操作</h2>
            <div class="batch-actions">
                <button class="btn btn-danger" onclick="clearAllGroups()">清除所有組別的程式碼</button>
                <button class="btn btn-primary" onclick="saveAllTasks()">儲存所有任務</button>
            </div>
        </section>
    </main>

    <script>
        const taskTemplates = {
            // 基礎練習
            1: {
                1: "【變數練習】宣告姓名、年齡、身高三個變數，並印出自我介紹",
                2: "【計算機】計算 123 + 456、789 - 123、12 * 34、100 / 7 的結果",
                3: "【字串操作】將 'Hello World' 轉成大寫、小寫、反轉，並計算長度",
                4: "【列表操作】建立 1-10 的列表，印出總和、平均、最大、最小值",
                5: "【字典練習】建立一個學生資料字典（姓名、學號、成績），並印出內容",
                6: "【迴圈練習】用 for 迴圈印出 1-100 中所有 3 的倍數"
            },
            // 演算法
            2: {
                1: "【二分搜尋】電腦隨機產生 1-100 的答案，用二分法自動猜測並印出過程",
                2: "【排序比較】產生 10 個隨機數字，分別用氣泡排序和選擇排序印出過程",
                3: "【費氏數列】印出費氏數列前 20 項，並計算第 20 項的值",
                4: "【質數篩選】找出 1-100 之間所有的質數",
                5: "【最大公因數】實作輾轉相除法，計算 48 和 18 的最大公因數",
                6: "【河內塔】印出 4 個圓盤的河內塔移動步驟"
            },
            // 圖形輸出
            3: {
                1: "【聖誕樹】用 * 符號印出高度為 10 的聖誕樹（三角形加樹幹）",
                2: "【菱形】用 * 符號印出寬度為 9 的菱形",
                3: "【空心方形】用 * 符號印出邊長為 8 的空心方形",
                4: "【數字金字塔】印出數字金字塔（1, 12, 123, 1234...共 9 行）",
                5: "【九九乘法表】印出格式整齊的九九乘法表",
                6: "【Pascal 三角形】印出巴斯卡三角形前 10 行"
            },
            // 資料處理
            4: {
                1: "【成績統計】建立 10 位學生的成績列表，計算平均、最高、最低、及格人數",
                2: "【詞頻統計】統計 'to be or not to be that is the question' 每個單字出現次數",
                3: "【氣溫分析】建立一週氣溫資料，找出最熱最冷的日子並計算平均溫度",
                4: "【重複過濾】從 [1,2,2,3,3,3,4,4,4,4] 中移除重複元素",
                5: "【分組統計】將 1-20 分成奇數和偶數兩組，分別計算總和",
                6: "【成績等第】將 [85,72,90,66,58,95,43,77] 轉換成等第（A/B/C/D/F）"
            },
            // 模擬實驗
            5: {
                1: "【擲硬幣】模擬擲硬幣 10000 次，統計正反面次數和機率",
                2: "【骰子統計】模擬擲 2 顆骰子 10000 次，統計每種點數和的機率",
                3: "【蒙地卡羅】用隨機投點法估算圓周率（投 100000 個點）",
                4: "【生日悖論】模擬 1000 次，驗證 23 人中至少兩人同生日的機率",
                5: "【隨機漫步】模擬 2D 隨機漫步 1000 步，計算最終距離原點的距離",
                6: "【抽獎模擬】模擬抽獎 1000 次，統計 1/100 中獎率的實際結果"
            },
            // 綜合挑戰
            6: {
                1: "【密碼產生器】產生 5 組 12 位隨機密碼，包含大小寫字母、數字和符號",
                2: "【凱薩密碼】將 'HELLO WORLD' 用位移 3 加密，再解密回來",
                3: "【摩斯密碼】將 'SOS' 轉成摩斯密碼，再轉回英文驗證",
                4: "【撲克牌】模擬洗牌並抽 5 張，判斷是否為同花、順子、對子等牌型",
                5: "【數字轉換】將十進位 255 轉成二進位、八進位、十六進位",
                6: "【文字遊戲】檢查 'racecar'、'hello'、'level' 是否為回文"
            }
        };

        function saveTask(groupId) {
            const task = document.getElementById(`admin-task-${groupId}`).value;

            if (!confirm(`確定要更新第 ${groupId} 組的任務嗎？\n\n如果該組有程式碼或執行結果，將會自動儲存到歷史紀錄中。`)) {
                return;
            }

            fetch(`/python_playground/task/${groupId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task: task, save_history: true})
            })
            .then(response => response.json())
            .then(data => {
                alert(`第 ${groupId} 組任務已更新！\n歷史紀錄數量: ${data.history_count}`);
                // 更新歷史徽章
                const badge = document.getElementById(`history-badge-${groupId}`);
                if (badge) badge.textContent = `歷史: ${data.history_count}`;
            });
        }

        function saveAllTasks() {
            if (!confirm('確定要更新所有組別的任務嗎？\n\n各組若有程式碼或執行結果，將會自動儲存到歷史紀錄中。')) {
                return;
            }

            const tasks = {};
            for (let i = 1; i <= 6; i++) {
                tasks[i] = document.getElementById(`admin-task-${i}`).value;
            }
            fetch('/python_playground/all_tasks', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tasks: tasks, save_history: true})
            })
            .then(response => response.json())
            .then(data => {
                alert('所有任務已更新！各組的舊任務已儲存至歷史紀錄。');
                location.reload();
            });
        }

        function assignToAll() {
            const task = document.getElementById('quick-task').value;
            if (!task.trim()) {
                alert('請輸入任務內容！');
                return;
            }
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`admin-task-${i}`).value = task;
            }
            saveAllTasks();
        }

        function useTemplate(templateId) {
            const template = taskTemplates[templateId];
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`admin-task-${i}`).value = template[i];
            }
            alert('已載入任務範本，請按「儲存所有任務」確認！');
        }

        function clearAllGroups() {
            if (!confirm('確定要清除所有組別的程式碼嗎？')) return;

            const promises = [];
            for (let i = 1; i <= 6; i++) {
                promises.push(
                    fetch(`/python_playground/clear/${i}`, {method: 'POST'})
                );
            }
            Promise.all(promises).then(() => {
                alert('所有組別已清除！');
                location.reload();
            });
        }
    </script>
</body>
</html>
