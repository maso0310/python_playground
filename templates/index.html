<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Python Playground - 智慧農業課程</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Python Playground</h1>
            <p class="hide-mobile">智慧農業課程 - Python 程式練習平台</p>
        </div>
        <nav>
            <a href="/python_playground/" class="active">練習區</a>
            <a href="/python_playground/browse">成果總覽</a>
        </nav>
    </header>

    <!-- 組別選擇器（手機版顯示在最上方） -->
    <div class="group-selector-mobile">
        <label for="mobile-group-select">選擇組別：</label>
        <select id="mobile-group-select" onchange="scrollToGroup(this.value)">
            {% for group_id in range(1, 7) %}
            <option value="{{ group_id }}">第 {{ group_id }} 組</option>
            {% endfor %}
        </select>
    </div>

    <main class="playground-container" id="playground-container">
        {% for group_id in range(1, 7) %}
        <section class="group-section" id="group-{{ group_id }}">
            <div class="group-title">
                <h2>第 {{ group_id }} 組</h2>
                <span class="completed-badge" id="badge-{{ group_id }}">0 / 18 題</span>
            </div>

            <!-- 題目列表（預設顯示） -->
            <div class="tasks-list" id="tasks-list-{{ group_id }}">
                {% for task_id, task_text in group_tasks[group_id].items() %}
                <div class="task-card" id="task-card-{{ group_id }}-{{ task_id }}">
                    <div class="task-card-header">
                        <span class="task-number">題目 {{ task_id }}</span>
                        <span class="task-status" id="task-status-{{ group_id }}-{{ task_id }}">未完成</span>
                    </div>
                    <div class="task-desc" onclick="openEditor({{ group_id }}, {{ task_id }})">{{ task_text }}</div>
                    <div class="task-card-actions">
                        <button class="btn btn-copy" onclick="copyTask({{ group_id }}, {{ task_id }}, event)">複製題目</button>
                        <button class="btn btn-start" onclick="openEditor({{ group_id }}, {{ task_id }})">開始作答</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- 編輯器區域（點擊題目後顯示） -->
            <div class="editor-fullscreen" id="editor-{{ group_id }}" style="display: none;">
                <div class="editor-header-bar">
                    <div class="editor-title">
                        <span class="editor-group">第 {{ group_id }} 組</span>
                        <span class="editor-task-num" id="editor-task-num-{{ group_id }}"></span>
                    </div>
                    <button class="btn btn-back-menu" onclick="closeEditor({{ group_id }})">返回選單</button>
                </div>

                <div class="editor-task-container">
                    <div class="editor-task-desc" id="editor-task-desc-{{ group_id }}"></div>
                    <button class="btn btn-copy-small" onclick="copyCurrentTask({{ group_id }})" title="複製題目去問 AI">複製題目</button>
                </div>

                <div class="editor-main">
                    <div class="editor-code-section">
                        <div class="section-toolbar">
                            <span class="section-label">程式碼</span>
                            <div class="section-actions">
                                <button class="btn btn-run" onclick="runCode({{ group_id }})">執行</button>
                                <button class="btn btn-clear" onclick="clearCode({{ group_id }})">清除</button>
                            </div>
                        </div>
                        <textarea id="code-{{ group_id }}" class="code-editor-full" placeholder="在這裡輸入 Python 程式碼..."></textarea>
                    </div>

                    <div class="editor-output-section">
                        <div class="section-toolbar">
                            <span class="section-label">執行結果</span>
                            <span class="last-run-time" id="last-run-{{ group_id }}"></span>
                        </div>
                        <pre id="output-{{ group_id }}" class="output-area-full"></pre>
                    </div>
                </div>
            </div>
        </section>
        {% endfor %}
    </main>

    <script>
        // 當前編輯狀態
        let currentEditor = { groupId: null, taskId: null };

        // 題目資料
        const groupTasks = {{ group_tasks | tojson }};

        // 複製題目到剪貼板
        function copyTask(groupId, taskId, event) {
            if (event) event.stopPropagation();

            const taskText = groupTasks[groupId][taskId];
            const prompt = `請幫我用 Python 完成以下題目：\n\n${taskText}\n\n請提供完整的程式碼和執行結果。`;

            navigator.clipboard.writeText(prompt).then(() => {
                showCopyFeedback(event ? event.target : null, '已複製！');
            }).catch(err => {
                // fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = prompt;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopyFeedback(event ? event.target : null, '已複製！');
            });
        }

        // 複製當前編輯器的題目
        function copyCurrentTask(groupId) {
            if (currentEditor.taskId) {
                copyTask(groupId, currentEditor.taskId, null);
                const btn = document.querySelector(`#editor-${groupId} .btn-copy-small`);
                showCopyFeedback(btn, '已複製！');
            }
        }

        // 顯示複製成功的反饋
        function showCopyFeedback(button, message) {
            if (button) {
                const originalText = button.textContent;
                button.textContent = message;
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 1500);
            }
        }

        // 滾動到指定組別
        function scrollToGroup(groupId) {
            const el = document.getElementById(`group-${groupId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 開啟編輯器
        function openEditor(groupId, taskId) {
            currentEditor = { groupId, taskId };

            // 載入題目資料
            fetch(`/python_playground/get_task/${groupId}/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`editor-task-num-${groupId}`).textContent = `題目 ${taskId}`;
                    document.getElementById(`editor-task-desc-${groupId}`).textContent = data.task;
                    document.getElementById(`code-${groupId}`).value = data.code || '';
                    document.getElementById(`output-${groupId}`).textContent = data.output || '';
                    document.getElementById(`last-run-${groupId}`).textContent =
                        data.last_run ? `最後執行: ${data.last_run}` : '';
                });

            // 隱藏其他組別，展開當前組別的編輯器
            for (let i = 1; i <= 6; i++) {
                const section = document.getElementById(`group-${i}`);
                const tasksList = document.getElementById(`tasks-list-${i}`);
                const editor = document.getElementById(`editor-${i}`);

                if (i === groupId) {
                    section.classList.add('fullscreen');
                    tasksList.style.display = 'none';
                    editor.style.display = 'flex';
                } else {
                    section.classList.add('hidden');
                }
            }

            // 容器變成單欄
            document.getElementById('playground-container').classList.add('single-column');

            // 滾動到頂部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 關閉編輯器
        function closeEditor(groupId) {
            // 自動儲存
            const code = document.getElementById(`code-${groupId}`).value;
            if (code.trim() && currentEditor.taskId) {
                saveCode(groupId, currentEditor.taskId);
            }

            // 恢復所有組別顯示
            for (let i = 1; i <= 6; i++) {
                const section = document.getElementById(`group-${i}`);
                const tasksList = document.getElementById(`tasks-list-${i}`);
                const editor = document.getElementById(`editor-${i}`);

                section.classList.remove('fullscreen', 'hidden');
                tasksList.style.display = 'grid';
                editor.style.display = 'none';
            }

            // 容器恢復雙欄
            document.getElementById('playground-container').classList.remove('single-column');

            // 重新載入題目狀態
            loadGroupTaskStatus(groupId);

            currentEditor = { groupId: null, taskId: null };
        }

        // 載入組別所有題目的狀態
        function loadGroupTaskStatus(groupId) {
            for (let taskId = 1; taskId <= 18; taskId++) {
                fetch(`/python_playground/get_task/${groupId}/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        const statusEl = document.getElementById(`task-status-${groupId}-${taskId}`);
                        const cardEl = document.getElementById(`task-card-${groupId}-${taskId}`);

                        if (data.last_run) {
                            statusEl.textContent = '已完成';
                            statusEl.classList.add('done');
                            cardEl.classList.add('completed');
                        } else {
                            statusEl.textContent = '未完成';
                            statusEl.classList.remove('done');
                            cardEl.classList.remove('completed');
                        }
                    });
            }
        }

        // 執行程式碼
        function runCode(groupId) {
            const taskId = currentEditor.taskId;
            if (!taskId) return;

            const code = document.getElementById(`code-${groupId}`).value;
            const outputArea = document.getElementById(`output-${groupId}`);

            if (!code.trim()) {
                outputArea.textContent = '[提示] 請先輸入程式碼！';
                return;
            }

            outputArea.textContent = '正在執行程式碼...';

            fetch(`/python_playground/run/${groupId}/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                outputArea.textContent = data.output || '（無輸出）';
                document.getElementById(`last-run-${groupId}`).textContent =
                    `最後執行: ${data.last_run}`;
                updateGroupBadge(groupId);
            })
            .catch(error => {
                outputArea.textContent = `[錯誤] ${error.message}`;
            });
        }

        // 儲存程式碼
        function saveCode(groupId, taskId) {
            const code = document.getElementById(`code-${groupId}`).value;

            fetch(`/python_playground/save/${groupId}/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });
        }

        // 清除程式碼
        function clearCode(groupId) {
            if (!confirm('確定要清除程式碼嗎？')) return;

            document.getElementById(`code-${groupId}`).value = '';
            document.getElementById(`output-${groupId}`).textContent = '';
        }

        // 更新組別完成數量徽章
        function updateGroupBadge(groupId) {
            fetch('/python_playground/get_group_summary')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById(`badge-${groupId}`);
                    if (badge && data[groupId]) {
                        badge.textContent = `${data[groupId].completed} / ${data[groupId].total} 題`;
                    }
                });
        }

        // 初始化載入所有組別的狀態
        function initAll() {
            fetch('/python_playground/get_group_summary')
                .then(response => response.json())
                .then(data => {
                    for (let groupId = 1; groupId <= 6; groupId++) {
                        const badge = document.getElementById(`badge-${groupId}`);
                        if (badge && data[groupId]) {
                            badge.textContent = `${data[groupId].completed} / ${data[groupId].total} 題`;
                        }
                        loadGroupTaskStatus(groupId);
                    }
                });
        }

        // Ctrl+Enter 快捷鍵執行
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.classList.contains('code-editor-full')) {
                    const groupId = parseInt(activeElement.id.replace('code-', ''));
                    runCode(groupId);
                }
            }
        });

        // Tab 鍵支援
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Tab' && event.target.classList.contains('code-editor-full')) {
                event.preventDefault();
                const editor = event.target;
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + 4;
            }
        });

        // 自動儲存（每 30 秒）
        setInterval(function() {
            if (currentEditor.groupId && currentEditor.taskId) {
                const code = document.getElementById(`code-${currentEditor.groupId}`).value;
                if (code.trim()) {
                    saveCode(currentEditor.groupId, currentEditor.taskId);
                }
            }
        }, 30000);

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            initAll();
            document.querySelectorAll('.code-editor-full').forEach(editor => {
                editor.setAttribute('spellcheck', 'false');
            });
        });
    </script>
</body>
</html>
