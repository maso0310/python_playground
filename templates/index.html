<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Python Playground - 智慧農業課程</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Python Playground</h1>
            <p class="hide-mobile">智慧農業課程 - Python 程式練習平台</p>
        </div>
        <nav>
            <a href="/python_playground/" class="active">練習區</a>
            <a href="/python_playground/browse">成果總覽</a>
        </nav>
    </header>

    <!-- 組別選擇器（手機版顯示在最上方） -->
    <div class="group-selector-mobile">
        <label for="mobile-group-select">選擇組別：</label>
        <select id="mobile-group-select" onchange="scrollToGroup(this.value)">
            {% for group_id in range(1, 7) %}
            <option value="{{ group_id }}">第 {{ group_id }} 組 - {{ group_names[group_id] }}</option>
            {% endfor %}
        </select>
    </div>

    <main class="playground-container">
        {% for group_id in range(1, 7) %}
        <section class="group-section" id="group-{{ group_id }}">
            <div class="group-title">
                <div class="group-title-left">
                    <h2>第 {{ group_id }} 組</h2>
                    <span class="group-category">{{ group_names[group_id] }}</span>
                </div>
                <span class="completed-badge" id="badge-{{ group_id }}">0 / 6 題</span>
            </div>

            <div class="tasks-area" id="tasks-area-{{ group_id }}">
                {% for task_id, task_text in group_tasks[group_id].items() %}
                <div class="task-item" id="task-item-{{ group_id }}-{{ task_id }}">
                    <!-- 題目標題（可點擊展開） -->
                    <div class="task-header-bar" id="task-header-{{ group_id }}-{{ task_id }}"
                         onclick="toggleTask({{ group_id }}, {{ task_id }})">
                        <div class="task-header-left">
                            <span class="task-number">題目 {{ task_id }}</span>
                            <span class="task-status-icon" id="status-icon-{{ group_id }}-{{ task_id }}"></span>
                        </div>
                        <span class="task-toggle-icon" id="toggle-icon-{{ group_id }}-{{ task_id }}">展開</span>
                    </div>

                    <!-- 題目內容（展開後顯示） -->
                    <div class="task-content" id="task-content-{{ group_id }}-{{ task_id }}" style="display: none;">
                        <div class="task-description">
                            <strong>題目：</strong>{{ task_text }}
                        </div>

                        <div class="editor-section">
                            <div class="editor-toolbar">
                                <span class="toolbar-label">程式碼</span>
                                <div class="toolbar-actions">
                                    <button class="btn btn-run" onclick="runCode({{ group_id }}, {{ task_id }}); event.stopPropagation();">執行</button>
                                    <button class="btn btn-clear" onclick="clearCode({{ group_id }}, {{ task_id }}); event.stopPropagation();">清除</button>
                                </div>
                            </div>
                            <textarea id="code-{{ group_id }}-{{ task_id }}"
                                      class="code-editor"
                                      placeholder="在這裡輸入 Python 程式碼..."
                                      onclick="event.stopPropagation();"></textarea>
                        </div>

                        <div class="output-section">
                            <div class="output-toolbar">
                                <span class="toolbar-label">執行結果</span>
                                <span class="last-run-time" id="last-run-{{ group_id }}-{{ task_id }}"></span>
                            </div>
                            <pre id="output-{{ group_id }}-{{ task_id }}" class="output-area"></pre>
                        </div>

                        <button class="btn btn-collapse" onclick="collapseTask({{ group_id }}, {{ task_id }}); event.stopPropagation();">
                            收起題目
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endfor %}
    </main>

    <script>
        // 追蹤各組當前展開的題目
        const expandedTasks = {};
        for (let i = 1; i <= 6; i++) {
            expandedTasks[i] = null;
        }

        // 滾動到指定組別
        function scrollToGroup(groupId) {
            const el = document.getElementById(`group-${groupId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 切換題目展開/收起
        function toggleTask(groupId, taskId) {
            const currentExpanded = expandedTasks[groupId];

            if (currentExpanded === taskId) {
                // 如果點擊的是當前展開的題目，收起它
                collapseTask(groupId, taskId);
            } else {
                // 先收起之前展開的題目
                if (currentExpanded !== null) {
                    collapseTaskUI(groupId, currentExpanded);
                }
                // 展開新題目
                expandTask(groupId, taskId);
            }
        }

        // 展開題目
        function expandTask(groupId, taskId) {
            expandedTasks[groupId] = taskId;

            // 載入題目資料
            fetch(`/python_playground/get_task/${groupId}/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`code-${groupId}-${taskId}`).value = data.code || '';
                    document.getElementById(`output-${groupId}-${taskId}`).textContent = data.output || '';
                    document.getElementById(`last-run-${groupId}-${taskId}`).textContent =
                        data.last_run ? `最後執行: ${data.last_run}` : '';

                    // 更新狀態圖示
                    updateStatusIcon(groupId, taskId, !!data.last_run);
                });

            // 隱藏其他題目，展開當前題目
            for (let i = 1; i <= 6; i++) {
                const item = document.getElementById(`task-item-${groupId}-${i}`);
                const content = document.getElementById(`task-content-${groupId}-${i}`);
                const toggleIcon = document.getElementById(`toggle-icon-${groupId}-${i}`);

                if (i === taskId) {
                    item.classList.add('expanded');
                    content.style.display = 'block';
                    toggleIcon.textContent = '收起';
                } else {
                    item.classList.add('collapsed');
                    item.classList.remove('expanded');
                    content.style.display = 'none';
                    toggleIcon.textContent = '展開';
                }
            }

            // 滾動到展開的題目
            setTimeout(() => {
                const item = document.getElementById(`task-item-${groupId}-${taskId}`);
                item.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // 收起題目
        function collapseTask(groupId, taskId) {
            // 自動儲存
            const code = document.getElementById(`code-${groupId}-${taskId}`).value;
            if (code.trim()) {
                saveCode(groupId, taskId);
            }

            collapseTaskUI(groupId, taskId);
            expandedTasks[groupId] = null;

            // 重新載入所有題目狀態
            loadGroupTaskStatus(groupId);
        }

        // 收起題目的 UI 變化
        function collapseTaskUI(groupId, taskId) {
            // 顯示所有題目
            for (let i = 1; i <= 6; i++) {
                const item = document.getElementById(`task-item-${groupId}-${i}`);
                const content = document.getElementById(`task-content-${groupId}-${i}`);
                const toggleIcon = document.getElementById(`toggle-icon-${groupId}-${i}`);

                item.classList.remove('expanded', 'collapsed');
                content.style.display = 'none';
                toggleIcon.textContent = '展開';
            }
        }

        // 更新狀態圖示
        function updateStatusIcon(groupId, taskId, isCompleted) {
            const icon = document.getElementById(`status-icon-${groupId}-${taskId}`);
            if (isCompleted) {
                icon.innerHTML = '<span class="status-done-dot"></span>';
                icon.title = '已完成';
            } else {
                icon.innerHTML = '';
                icon.title = '';
            }
        }

        // 載入組別所有題目的狀態
        function loadGroupTaskStatus(groupId) {
            for (let taskId = 1; taskId <= 6; taskId++) {
                fetch(`/python_playground/get_task/${groupId}/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateStatusIcon(groupId, taskId, !!data.last_run);
                    });
            }
        }

        // 執行程式碼
        function runCode(groupId, taskId) {
            const code = document.getElementById(`code-${groupId}-${taskId}`).value;
            const outputArea = document.getElementById(`output-${groupId}-${taskId}`);

            if (!code.trim()) {
                outputArea.textContent = '[提示] 請先輸入程式碼！';
                return;
            }

            outputArea.textContent = '正在執行程式碼...';

            fetch(`/python_playground/run/${groupId}/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                outputArea.textContent = data.output || '（無輸出）';
                document.getElementById(`last-run-${groupId}-${taskId}`).textContent =
                    `最後執行: ${data.last_run}`;
                updateStatusIcon(groupId, taskId, true);
                updateGroupBadge(groupId);
            })
            .catch(error => {
                outputArea.textContent = `[錯誤] ${error.message}`;
            });
        }

        // 儲存程式碼
        function saveCode(groupId, taskId) {
            const code = document.getElementById(`code-${groupId}-${taskId}`).value;

            fetch(`/python_playground/save/${groupId}/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });
        }

        // 清除程式碼
        function clearCode(groupId, taskId) {
            if (!confirm('確定要清除程式碼嗎？')) return;

            document.getElementById(`code-${groupId}-${taskId}`).value = '';
            document.getElementById(`output-${groupId}-${taskId}`).textContent = '';
        }

        // 更新組別完成數量徽章
        function updateGroupBadge(groupId) {
            fetch('/python_playground/get_group_summary')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById(`badge-${groupId}`);
                    if (badge && data[groupId]) {
                        badge.textContent = `${data[groupId].completed} / ${data[groupId].total} 題`;
                    }
                });
        }

        // 初始化載入所有組別的狀態
        function initAll() {
            fetch('/python_playground/get_group_summary')
                .then(response => response.json())
                .then(data => {
                    for (let groupId = 1; groupId <= 6; groupId++) {
                        const badge = document.getElementById(`badge-${groupId}`);
                        if (badge && data[groupId]) {
                            badge.textContent = `${data[groupId].completed} / ${data[groupId].total} 題`;
                        }
                        loadGroupTaskStatus(groupId);
                    }
                });
        }

        // Ctrl+Enter 快捷鍵執行
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.classList.contains('code-editor')) {
                    const parts = activeElement.id.split('-');
                    const groupId = parseInt(parts[1]);
                    const taskId = parseInt(parts[2]);
                    runCode(groupId, taskId);
                }
            }
        });

        // Tab 鍵支援
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Tab' && event.target.classList.contains('code-editor')) {
                event.preventDefault();
                const editor = event.target;
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + 4;
            }
        });

        // 自動儲存（每 30 秒）
        setInterval(function() {
            for (let groupId = 1; groupId <= 6; groupId++) {
                const taskId = expandedTasks[groupId];
                if (taskId) {
                    const code = document.getElementById(`code-${groupId}-${taskId}`).value;
                    if (code.trim()) {
                        saveCode(groupId, taskId);
                    }
                }
            }
        }, 30000);

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            initAll();
            document.querySelectorAll('.code-editor').forEach(editor => {
                editor.setAttribute('spellcheck', 'false');
            });
        });
    </script>
</body>
</html>
